<!DOCTYPE html>
<html lang="en-GB">
    <head>
        <title>Admin</title>
        <meta charset="UTF-8">
        <meta name="description" content="">
        <meta name="keywords" content="">
        
        <link rel="shortcut icon" href="../EnterpriseWeb/images/favicon.ico">
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css">
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js"></script>
        <script src="jQuery_Cookie_Plugin_4.1/jquery.cookie.js"></script>
        <link href="style.css" rel="stylesheet" type="text/css" />
         <script src="Report.js"></script>
    <script>        
        $(document).ready(function(){
           pageReporting("Admin");
            
                
            if(typeof $.cookie("username") === 'undefined') {
               window.location.href = "login.html";

            }
                
                if($.cookie('role') == 2){
                    
                }else{
                    window.location.href=('index.html');
                }
                
                
                 $.ajax({
                    type: "POST",
                    url: "PostController.php",

                    data: {
                        method:"categories",
                    },
                    cache: false,
                    dataType: 'JSON',
                    success: function(data, status, xhttp, errorMessage) {
                       
                        $.each(data, function(i ,val) {


                            $('.CategoriesDiv').append('<input type="text" value= '+val.name+' id=Cat'+val.category_id+'><button id ='+val.category_id+' value=Update>Update</button><button id ='+val.category_id+' value=Delete>Delete</button>&nbsp;&nbsp;&nbsp;');
                        });
                            $('.CategoriesDiv').append('<br /> <br />');
                        $('.CategoriesDiv').append('<label for="NewCat">New category to add:&nbsp;</label><input type="text" id="NewCat"><button value=Add id="New">Add</button>');
                    },
                    error: function(result) {
                        $('#Alerts').append('<div class="alert alert-danger alert-dismissible fade show" role="alert">Error; please contact your system administrator<button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button></div>');
                    }
                });
              
                 $.ajax({
                    type: "POST",
                    url: "AdminController.php",

                    data: {
                        method:"getUsers"
                    },
                    cache: false,
                    dataType: 'JSON',
                    success: function(data, status, xhttp, errorMessage) {
                      
                        
                        $.each(data.results, function(i ,val) {
                            var timeStamp = new Date(val.last_login*1000);
                            var adminButton = null;
                            var banButton = null;
                            
                            if(val.role_id == 3){
                                 banButton = '<button value= "RevokeBan" ID='+val.user_id+'>Unban user</button>';
                             
                            }else{
                                banButton = '<button value= "Ban" ID='+val.user_id+'>Ban User</button>';  
                            }

                            if(val.role_id == 4){
                                 suspendButton = '<button value= "RevokeSuspend" ID='+val.user_id+'>Reinstate user</button>';
                             
                            }else{
                                suspendButton = '<button value= "Suspend" ID='+val.user_id+'>Suspend User</button>';  
                            }
                            
                            if(val.role_id == 2){
                                adminButton = '<button value= "RevokeAdmin" ID='+val.user_id+'>Revoke Admin</button>';
                             
                            }else{
                                adminButton = '<button value= "MakeAdmin" ID='+val.user_id+'>Make Admin</button>';  
                            }

                            $('#users').append('<tr><td>'+val.username+'</td> <td>'+val.role_name+'</td> <td>'+timeStamp+'</td> <td>'+adminButton+suspendButton+banButton+'</td></tr>');
                            
                        });
                            
                    },
                    error: function(result) {
                        $('#Alerts').append('<div class="alert alert-danger alert-dismissible fade show" role="alert">Error; please try again later<button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button></div>');
                        
                        
                    }
                });
                $.ajax({
                    type: "POST",
                    url: "AdminController.php",

                    data: {
                        method:"flaggedPosts"
                    },
                    cache: false,
                    dataType: 'JSON',
                    success: function(data, status, xhttp, errorMessage) {
                      
                        
                        $.each(data.results, function(i ,val) {
                            
                            var timeStamp = new Date(val.post_date*1000);
                            $('#posts').append('<tr><td>'+val.username+'</td> <td>'+val.title+'</td> <td>'+val.description+'</td><td>'+timeStamp+'</td> <td>'+val.category+'</td><td><button value="RemovePost" id='+val.post_id+'>Remove post</button></td></tr>');
                            
                        });
                            
                    },
                    error: function(result) {
                        $('#Alerts').append('<div class="alert alert-danger alert-dismissible fade show" role="alert">Error; please try again later<button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button></div>');
                    }
                });
                

            });
            
        </script>
        <script>
            $(document).ready(function(){
                 
            
                $(document).on("click",".CategoriesDiv button", function() {
                    var IDValue = $(this).attr("id");
                    var buttonType = $(this).val();
                    console.log(IDValue, buttonType);
                    
                    if(buttonType == 'Add'){
                        var newCat = $("#NewCat").val();
                        //console.log(newCat);
                        $.ajax({
                            type: "POST",
                            url: "AdminController.php",
                            data: {
                                method:"createCategory",
                                name: newCat
                            },
                            cache: false,
                            dataType: 'JSON',
                            success: function(data, status, xhttp, errorMessage) {
                            location.reload();  
                            },
                            error: function(result) {
                                $('#Alerts').append('<div class="alert alert-danger alert-dismissible fade show" role="alert">Error; please try again later<button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button></div>');
                            }    
                        });
                        
                    }else if(buttonType == 'Delete'){
                        var m = confirm('Are you sure you want to delete this category?');
                        if(m == true){
                            console.log('confirm');
                            $.ajax({
                                type: "POST",
                                url: "AdminController.php",
                                data: {
                                    method:"deleteCategory",
                                    categoryId: IDValue
                                },
                                cache: false,
                                dataType: 'JSON',
                                success: function(data, status, xhttp, errorMessage) {
                                    location.reload();
                                },
                                error: function(result) {
                                    $('#Alerts').append('<div class="alert alert-danger alert-dismissible fade show" role="alert">Error; please try again later<button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button></div>');
                                }
                            });
                            
                        }else{
                            console.log('Nah fam');
                        }   
                    }else if (buttonType == 'Update'){
                        var catToUpdate = "Cat" + IDValue
                        var catValue =  $('#' + catToUpdate).val();
                        console.log(catToUpdate, catValue);
                        
                        $.ajax({
                                type: "POST",
                                url: "AdminController.php",
                                data: {
                                    method:"updateCategory",
                                    categoryId: IDValue,
                                    categoryName: catValue
                                },
                                cache: false,
                                dataType: 'JSON',
                                success: function(data, status, xhttp, errorMessage) {
                                    location.reload();
                                },
                                error: function(result) {
                                    $('#Alerts').append('<div class="alert alert-danger alert-dismissible fade show" role="alert">Error; please try again later<button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button></div>');
                                }
                            });
                            
                        
                       
                    } 
                });
                
                
                $(document).on("click",".User button", function() {
                     var IDValue = $(this).attr("id");
                    var buttonType = $(this).val();
                    console.log(IDValue, buttonType);
                    
                    if(buttonType == 'Ban'){
                        
                        $.ajax({
                                type: "POST",
                                url: "AdminController.php",
                                data: {
                                    method:"changeRole",
                                    userId:IDValue ,
                                    roleId: 3
                                    
                                },
                                cache: false,
                                dataType: 'JSON',
                                success: function(data, status, xhttp, errorMessage) {
                                    $.ajax({
                                        type: "POST",
                                        url: "AdminController.php",
                                        data: {
                                            method:"mutingPosts",
                                            userId:IDValue

                                        },
                                        cache: false,
                                        dataType: 'JSON',
                                        success: function(data, status, xhttp, errorMessage) {
                                            location.reload();
                                        },
                                        error: function(result) {
                                            $('#Alerts').append('<div class="alert alert-danger alert-dismissible fade show" role="alert">Error; please try again later<button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button></div>');
                                        }
                                    });
                                    
                                    
                                },
                                error: function(result) {
                                    $('#Alerts').append('<div class="alert alert-danger alert-dismissible fade show" role="alert">Error; please try again later<button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button></div>');
                                }
                            });
                            
                    }else if(buttonType == 'RevokeSuspend'||buttonType == 'RevokeBan'){
                              $.ajax({
                                type: "POST",
                                url: "AdminController.php",
                                data: {
                                    method:"changeRole",
                                    userId:IDValue ,
                                    roleId: 1
                                    
                                },
                                cache: false,
                                dataType: 'JSON',
                                success: function(data, status, xhttp, errorMessage) {
                                    if(buttonType == 'RevokeBan'){
                                        $.ajax({
                                            type: "POST",
                                            url: "AdminController.php",
                                            data: {
                                                method:"unmutingPosts",
                                                userId:IDValue

                                            },
                                            cache: false,
                                            dataType: 'JSON',
                                            success: function(data, status, xhttp, errorMessage) {
                                                location.reload();
                                            },
                                            error: function(result) {
                                                $('#Alerts').append('<div class="alert alert-danger alert-dismissible fade show" role="alert">Error; please try again later<button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button></div>');
                                            }
                                        });
                                    }else{
                                     location.reload();    
                                    }
                                    
                                    
                                    
                                },
                                error: function(result) {
                                    $('#Alerts').append('<div class="alert alert-danger alert-dismissible fade show" role="alert">Error; please try again later<button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button></div>');
                                }
                            });
                             
                    }else if(buttonType == 'Suspend'){
                              
                        $.ajax({
                                type: "POST",
                                url: "AdminController.php",
                                data: {
                                    method:"changeRole",
                                    userId: IDValue ,
                                    roleId: 4
                                    
                                },
                                cache: false,
                                dataType: 'JSON',
                                success: function(data, status, xhttp, errorMessage) {
                                    location.reload();
                                },
                                error: function(result) {
                                    $('#Alerts').append('<div class="alert alert-danger alert-dismissible fade show" role="alert">Error; please try again later<button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button></div>');
                                }
                            });
                            
                        
                        
                    }else if (buttonType == 'MakeAdmin'){
                        $.ajax({
                                type: "POST",
                                url: "AdminController.php",
                                data: {
                                    method:"changeRole",
                                    userId: IDValue ,
                                    roleId: 2
                                    
                                },
                                cache: false,
                                dataType: 'JSON',
                                success: function(data, status, xhttp, errorMessage) {
                                    location.reload();
                                },
                                error: function(result) {
                                    $('#Alerts').append('<div class="alert alert-danger alert-dismissible fade show" role="alert">Error; please try again later<button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button></div>');
                                }
                            });       
                        
                    }else if(buttonType == 'RevokeAdmin'){
                             $.ajax({
                                type: "POST",
                                url: "AdminController.php",
                                data: {
                                    method:"changeRole",
                                    userId:IDValue ,
                                    roleId: 1   
                                    
                                },
                                cache: false,
                                dataType: 'JSON',
                                success: function(data, status, xhttp, errorMessage) {
                                    location.reload();
                                },
                                error: function(result) {
                                    $('#Alerts').append('<div class="alert alert-danger alert-dismissible fade show" role="alert">Error; please try again later<button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button></div>');
                                }
                            });
                    }else{
                        $('#Alerts').append('<div class="alert alert-danger alert-dismissible fade show" role="alert">Error; please try again later<button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button></div>');
                    }
                    
                });
                
                
                $(document).on("click",".reports button", function() {
                    var IDValue = $(this).attr("id");
                    var buttonType = $(this).val();
                    console.log(IDValue, buttonType);
                    
                    if(buttonType == 'RemovePost'){   
                        var check =  confirm("Are you sure you want to remove this post?");
                        if(check == true){
                            $.ajax({
                                type: "POST",
                                url: "AdminController.php",
                                data: {
                                    method:"mutingSpecificPost",
                                    postId: IDValue ,
     
                                    
                                },
                                cache: false,
                                dataType: 'JSON',
                                success: function(data, status, xhttp, errorMessage) {
                                    location.reload();
                                },
                                error: function(result) {
                                   $('#Alerts').append('<div class="alert alert-danger alert-dismissible fade show" role="alert">Error; please try again later<button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button></div>');
                                }
                            });    
                        }else{
                            console.log('Not removed');
                        }
                        
                        
                       
                    }else{
                        $('#Alerts').append('<div class="alert alert-danger alert-dismissible fade show" role="alert">Error; please try again later<button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button></div>');
                    }
                
                });
                
            
            });
            
        </script>
    </head>
    <body>
         <div class="sticky-top">
        
            <nav class="navbar navbar-expand-sm bg-dark navbar-dark">
                <a class="navbar-brand" href="index.html">
                    <img src="../EnterpriseWeb/images/favicon.ico" width="30" height="30" class="d-inline-block align-top" alt="">Home</a>
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#collapsibleNavbar">
                <span class="navbar-toggler-icon"></span>
            </button>
                <div class="collapse navbar-collapse" id="collapsibleNavbar">
                    <ul class="navbar-nav">
                        <li class="nav-item">
                            <a class="nav-link" id="link1" href="register.html">Register</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" id="link2" href="login.html">Login</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" id="link3" href="upload.html">Suggest an Idea</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" id="link4" href="settings.html">User Settings</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" id="link5" href="Admin.html">Admin Settings</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" id="link6" href="ReportingandExporting.html">Reporting and Exporting</a>
                        </li>
                    </ul>                

                    <ul class="navbar-nav ml-auto">
                        <li class="nav-item">
                            <a class="nav-link disabled" id="session"></a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" id="link7" href="Logout.html">Logout</a>
                        </li>                    
                    </ul>
                    </div>
            </nav>
            <div id="Alerts"></div>
            <div id="LastLogin"></div>
        </div>   
        <script>
             $(document).ready(function(){                 
                 var username = $.cookie("username");
                 $("#session").text(username +" on session");
             if($.cookie("username")){
                $('#link1').prop("style", "display: none");
                $('#link2').prop("style", "display: none");
             }else{                              
                $('#link3').prop("style", "display: none");
                $('#link4').prop("style", "display: none");
                $('#link5').prop("style", "display: none");
                $('#link6').prop("style", "display: none");
                
             }
                 
                 if($.cookie("Deadline") == 1){
                $('#link3').addClass('disabled');
                $('#link3').attr('href', '#');
                $('#link3').append('&#128274;');
                $('#Alerts').append('<div class="alert alert-warning" role="alert">Its the end of the month! All this months submissions are being reviewed by your QA manager. No ideas can be submitted at this time.</div>');
            }
        
                 
                 
             });
        </script>
   
        
        <br/>
        <br/>
        <div class="container">
            <h1>Admin Settings</h1>
            <div class="jumbotron">
                <h2>Category Settings</h2>
                <div class="CategoriesDiv"></div>
                
            </div>
            
            <div class="jumbotron">
                <h2>User Options</h2>
                <!--<label for='Search'>Search Users:&nbsp;</label>
                <input type="text" id='Search'><button id=Search>Search</button>-->
                
                <div class=User>
                <table class="table">
                    <thead>
                        <th>Username</th>
                        <th>Role</th>
                        <th>Last Login</th>
                        <th>Options</th>
                    </thead>
                    <tbody id=users>
                    
                    </tbody>
                </table>
                </div>
            </div>
            
            <div class="jumbotron">  
                <br/>    
                <h2>Flagged Posts</h2>
                <br/>  
                <div class=reports>
                    <table class="table">
                        <thead>
                            <th>Posted by</th>
                            <th>Title</th>
                            <th>Content</th>
                            <th>Date</th>
                            <th>Category</th>
                            <th>Options</th>
                        </thead>
                        <tbody id=posts>
                        
                        </tbody>
                    </table>
                </div>
                

            </div>
            
        </div>
    </body>
</html>
