<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/tr/xhtml1/DTD/xhtml11.dtd" >
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-gb">
<head>
    <title>Index</title>
    <link rel="shortcut icon" href="../EnterpriseWeb/images/favicon.ico">
    <meta name="Author" content="ad9047o@gre.ac.uk"/>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
    <script src="jquery-3.3.1.min.js"></script>
    <script src="jQuery_Cookie_Plugin_4.1/jquery.cookie.js"></script>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
    <link href="style.css" rel="stylesheet" type="text/css" />
    <script> 
        $(document).ready(function(){
            
            
            var timeStamp = $.cookie("timeStamp");
            var dt = eval(timeStamp*1000);
            var mydate = new Date(dt);
            //var userId = $.cookie("userid");
            var username = $.cookie("username");
            
            
           if($.cookie("loginalert")) {
               
               if(timeStamp == 0 && $.cookie("username")) {
                $('#link1').prop("style", "display: none");
                $('#link2').prop("style", "display: none");
                
            }else{
                $('#link1').prop("style", "display: none");
                $('#link2').prop("style", "display: none");
                
            }              
               
               
           }else{
               
                if(timeStamp == 0 && $.cookie("username")) {
                $('#link1').prop("style", "display: none");
                $('#link2').prop("style", "display: none");
                alert("welcome " + username);
                $.cookie("loginalert", 1);
            }else{
                $('#link1').prop("style", "display: none");
                $('#link2').prop("style", "display: none");
                alert("welcome back " + username + " last login on "+ mydate);
                $.cookie("loginalert", 1);
            }
               
               
               
           }
            
            
            $("#session").text(username +" on session");
            
        });
        
    </script>  
</head>
    <body>
        <nav class="navbar navbar-expand-sm bg-dark navbar-dark">
            <a class="navbar-brand" href="index.html">
                <img src="../EnterpriseWeb/images/favicon.ico" width="30" height="30" class="d-inline-block align-top" alt="">Home</a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#collapsibleNavbar">
            <span class="navbar-toggler-icon"></span>
        </button>
            <div class="collapse navbar-collapse" id="collapsibleNavbar">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link" id="link1" href="register.html">Register</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" id="link2" href="login.html">Login</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" id="link3" href="upload.html">Suggest an Idea</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" id="link4" href="settings.html">User Settings</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" id="link5" href="Admin.html">Admin Settings</a>
                    </li>
                </ul>                
            </div>
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link disabled" id="session"></a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" id="link6" href="Logout.html">Logout</a>
                    </li>                    
                </ul>
        </nav>
        
        <br/>
        <br/>
        <div class="container">
            <h2>This months ideas</h2>
            <div id="paginationControls"></div>
            <div id="content"></div>
            

            </div>  
        <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
        <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>
    <script>
        $(document).ready(function(){
            var currentPage = 1;
            var userId = $.cookie('userid');
            var pageNum = 0;
            var pages = null;
            $.ajax({
                type: "POST",
                url: "PostController.php",
                data: {method:"listPost", userId:userId},
                cache: false,
                dataType: 'JSON',
                success: function(data, status, xhttp, errorMessage) {

                    pages = data.results;
                    var pageCount = data.pageCount;
                    pageNum = pageCount;
                    var pagination = $("#paginationControls");

                    pagination.append('<nav aria-label="Page navigation example">');
                    pagination.append('<ul class="pagination" id="paginationList">');
                    paginationList = $("#paginationList");
                    paginationList.append(' <li class="page-item"><btn class="page-link" name="previous" id="previous" href="#">Previous</button></li>');
                    for(var i = 1 ; i<pageCount +1 ; i ++){
                        paginationList.append('<li class="page-item"><button class="page-link" href="#" name='+i+'>'+i+'</button></li>');
                    }
                    paginationList.append('<li class="page-item"><button class="page-link" href="#" name="next" id="next">Next</button></li>');
                    pagination.append('</ul>');
                    pagination.append('</nav>');
                    checkButtons();
                    loadPosts(data.results[currentPage -1 ]);        

                        },
                        error: function(result) {
                            alert(result.message);
                        }
            });

            $(document).on("click", '#paginationControls li button', function(){
                var name = $(this).attr("name");
                if (name === "previous"){
                    currentPage = currentPage -1;
                    checkButtons();
                    loadPosts(pages[currentPage -1]);
                }
                else if( name === "next"){
                    currentPage = currentPage +1;
                    checkButtons();
                    loadPosts(pages[currentPage - 1]);
                }
                else{
                    currentPage = name;
                    checkButtons();
                    loadPosts(pages[currentPage - 1]);
                }
                
            });
                
            function checkButtons(){
                if(currentPage == 1 ){
                    $("#previous").prop("disabled", true);
                }
                if(currentPage == pageNum){
                    $("#next").prop("disabled", true);
                }
                if(currentPage != 1 || currentPage != pageNum){
                    $("#next").prop("disabled", false);
                     $("#previous").prop("disabled", false);
                }
            }
            
            function loadPosts(data){
                $("#content").empty();
                 $.each(data, function(i, val){
                         var edit ="";
                         var view ="";
                         var addcom ="";
                         view = '<a href="ideacomment.html?postId='+val.post_id+'">View Details</a>';
                         addcom = '<a href="addcomments.html?postId='+val.post_id+'">Add a comment</a>';
                         if(val.positive === 1){
                              var thumbsUp = '<button type="button" class="btn btn/default" id=ThumbsUp-'+val.post_id+' name="ThumbsUp" disabled="disabled"> <span class="glyphicon glyphicon-thumbsup" name="ThumbsUp">Thumbs Up</span></button>';
                              var thumbsDown = '<button type="button" class="btn btn/default" id=ThumbsDown-'+val.post_id+' name="ThumbsDown" > <span class="glyphicon glyphicon-thumbsdown" name="ThumbsDown">Thumbs Down</span></button>';
                         }else if (val.negative === 1){
                              var thumbsUp = '<button type="button" class="btn btn/default" id=ThumbsUp-'+val.post_id+' name="ThumbsUp" > <span class="glyphicon glyphicon-thumbsup" name="ThumbsUp">Thumbs Up</span></button>';
                              var thumbsDown = '<button type="button" class="btn btn/default" id=ThumbsDown-'+val.post_id+' name="ThumbsDown" disabled="disabled"> <span class="glyphicon glyphicon-thumbsdown" name="ThumbsDown">Thumbs Down</span></button>';
                         }else{
                              var thumbsUp = '<button type="button" class="btn btn/default" id=ThumbsUp-'+val.post_id+' name="ThumbsUp"> <span class="glyphicon glyphicon-thumbsup" name="ThumbsUp">Thumbs Up</span></button>';
                              var thumbsDown = '<button type="button" class="btn btn/default" id=ThumbsDown-'+val.post_id+' name="ThumbsDown" > <span class="glyphicon glyphicon-thumbsdown" name="ThumbsDown">Thumbs Down</span></button>';
                         }
                              var pointsBlock = '<div><p id="points'+val.post_id+'">'+val.points+'</p></div>';

                        if(userId == val.user_id){

                         edit = '<a href="editpost.html?postId='+val.post_id+'">Edit Post</a>';

                        }else{
                            edit = "<br/>";
                        }

                       $('#content').append('<div class="jumbotron"><div class="container"><p>'+val.username+'</p><h1>'+val.name+'</h1><hr/><p>'+val.description+'</p><p>'+val.category+'</p>'+pointsBlock+thumbsUp+thumbsDown+'<div>'+edit+'</div><div>'+view+'</div><div>'+addcom+'</div>');
                    });
            }
            function updateLocalPosts(postId, vote, score){
                $.each(pages[currentPage -1], function(i,val) {
                    if(val.post_id == postId){
                        if(vote == "positive"){
                            pages[currentPage -1][i].positive = 1;
                            pages[currentPage -1][i].negative = 0;
                            pages[currentPage -1][i].points = score;

                        }else{
                            pages[currentPage -1][i].positive = 0;
                            pages[currentPage -1][i].negative = 1;
                            pages[currentPage -1][i].points = score;
                        }
                    }    
                });    
            }
            

            $(document).on('click','#content :button',function(){
                var Id = $(this).attr("id");
                $(this).prop("disabled",true);
                var result = Id.split("-");
                var postId = result[1];
                var vote = $(this).attr("name");
                var voteVal = null;
                if (vote == "ThumbsUp"){
                    voteVal = "positive";
                    $("#ThumbsDown-"+postId).prop("disabled", false);
                }else{
                    voteVal = "negative";
                    $("#ThumbsUp-"+postId).prop("disabled", false);
                }
                var updated = true;
                 $.each(pages[currentPage -1], function(i,val) {
                    if(val.post_id == postId){
                        if(val.positive == null || val.negative == null){
                            updated = "false";
                        }else{
                            updated = "true";
                        }
                    }    
                });  
                 $.ajax({
                    type: "POST",
                    url: "CommentAndRatingController.php",
                    data: {method:"vote", userId:$.cookie('userid'), postId:postId, vote:vote, update:updated},
                    cache: false,
                    dataType: 'JSON',
                    success: function(data, status, xhttp, errorMessage) {
                        /*     $("#ThumbsUp-"+postId).attr("disabled", true);
                            $("#ThumbsDown-"+postId).attr("disabled", true);*/
                        $.ajax({
                           type:"POST",
                            url:"CommentAndRatingController.php",
                            data:{method:"points", postId:postId},
                            cache:false,
                            dataType: "JSON",
                            success: function(data){
                                $("#points"+postId).text(data.score);
                                updateLocalPosts(postId, voteVal, data.score);
                                //what ever button is clicked need to enable the other one.
                            },
                            error: function(data){
                                alert("your vote has been counted but we are currently unable to display the new score. Please refresh the page.");
                            }

                        });
                    },
                    error: function(date){
                           alert("Error voting on posts please try again later."); 
                    }
                 });
            });

        });         
    </script>
    </body>
    <!--<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>-->
</html>