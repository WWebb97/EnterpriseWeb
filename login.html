<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/tr/xhtml1/DTD/xhtml11.dtd" >
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-gb">
<head>
<link rel="shortcut icon" href="../EnterpriseWeb/images/favicon.ico">
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css">
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js"></script>
    <script src = "jQuery_Cookie_Plugin_4.1/jquery.cookie.js"></script>
    <script src="Report.js"></script>
<title>Login</title>
<meta name="Author" content="ad9047o@gre.ac.uk"/>
<link href="style.css" rel="stylesheet" type="text/css" />
</head>
    <body class="log">
        <div class="headerlog">
            <img src="images/greenwichlogo.png" class="logoresponsive" width="200px" height="50px"/>                            
        </div>
        <form>
        <div class="contentlog">
            <div class="input-group">                
  		        <label>Username</label>
  		        <input type="text" name="username" id="username" required>
            </div>
            <div class="input-group">
  		        <label>Password</label>
  		        <input type="password" name="password" id="password" required>
            </div>
            <div>
  		        <button type="button"  id="submitButton" class="refresh btnlog">Login </button>                

            </div><br/>
<!--            <p id="testingSpace">   </p> -->
             
    <script>        
        $(document).ready(function(){
           pageReporting("Login");
          
                    if($.cookie("username")) {
                       window.location.href = "index.html";

                    }
                     
                    $("#submitButton").click(function(){

                           var username = $("#username").val();
                           var password = $("#password").val();
                        $.ajax({
                            type: "POST",
                            url: "LoginController.php",
                            data: {method:"login", username:username, password:password},
                            cache: false,
                            dataType: 'JSON',
                            success: function(output) {
                                    $("#testingSpace").text("login= "+output.login+" verified = " +output.verified+ " userid =" +output.user_id);
                                             
                            var role = output.role_id;
                            if(role == 3) {
                                    //alert('You have been banned from the site');         
                   
                                 $('#Alerts').append('<div class="alert alert-warning" role="alert">Your account have been banned and its been reviewed by your QA manager.</div>');
                                 setTimeout(function() {
                                        location.reload();
                                    }, 3000);
                                
                            }else{
                                
                                if(output.login == true){
                                    
                                    $.cookie("userid", output.user_id);
                                    $.cookie("username", username);
                                    $.cookie("role", output.role_id);
                                    $.cookie("timeStamp", output.last_login);
                                    instanceReporting(output.user_id);
                                    
                                    
                                    if(output.verified == false){
                                        window.location.href = "Verification.html";

                                    }else{
                                        
                                         var timeStamp = new Date();
                                         var userId = $.cookie("userid");
                                        $.ajax({                            

                                            type: "POST",
                                            url: "LoginController.php",
                                            data: {method:"setLoginTime", timeStamp:timeStamp, userId:userId},
                                            cache: false,
                                            dataType: 'JSON',
                                            success: function(output) {
                                                    //$("#testingSpace").text("login= "+output.login+" verified = " +output.verified+ " userid =" +output.user_id);

                                                if(output.updated == true){
                                                    //alert('time recorded');

                                                }else{
                                                    alert('no time recorded');
                                                }
                                            }


                                            });
                                        
                                        window.location.href = "index.html";
//                                        
                                            
                                        
                                        
                                    }
                                    
                                }else{
                                    $('#Alerts').append('<div class="alert alert-warning" role="alert">Incorrect Login.</div>');
                                    setTimeout(function() {
                                        location.reload();
                                    }, 2000);
                                }
                                
                              }
                                
                            }
                            

                            });
                       
            
                        
                    });
                               
                   
                               
               });
            
            
            
            </script>
  	         <p>
  		        Not yet a member? <a href="register.html">Sign up</a>
  	         </p>
            <div id="Alerts"></div>
         </div>
        </form>

    </body>
</html>